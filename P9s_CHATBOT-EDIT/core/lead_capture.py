#Path : core/lead_capture.py
"""
core/lead_capture.py
---------------------------------------------------
à¹à¸¢à¸à¸Šà¸·à¹ˆà¸­à¹à¸¥à¸°à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸à¸—à¹Œà¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸‚à¸­à¸‡à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰
à¹€à¸¡à¸·à¹ˆà¸­à¹€à¸ˆà¸•à¸™à¸²à¹€à¸›à¹‡à¸™ "à¸ªà¸™à¹ƒà¸ˆà¸ªà¸¡à¸±à¸„à¸£"
"""

import re
from services.notification import notify_admin


def extract_phone(text: str) -> str:
    """
    à¸”à¸¶à¸‡à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£à¸¨à¸±à¸à¸—à¹Œà¸ˆà¸²à¸à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡ (à¸£à¸­à¸‡à¸£à¸±à¸š 9-10 à¸«à¸¥à¸±à¸)
    """
    match = re.search(r"(0\d{8,9})", text)
    return match.group(1) if match else "à¹„à¸¡à¹ˆà¸à¸šà¹€à¸šà¸­à¸£à¹Œ"


def extract_name(text: str) -> str:
    """
    à¸à¸¢à¸²à¸¢à¸²à¸¡à¹à¸¢à¸à¸Šà¸·à¹ˆà¸­ (à¹à¸šà¸šà¸‡à¹ˆà¸²à¸¢à¹† à¸ˆà¸²à¸à¸•à¹‰à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡)
    à¹€à¸Šà¹ˆà¸™ "à¸Šà¸·à¹ˆà¸­à¸à¸´à¸•à¸•à¸´à¸„à¸£à¸±à¸š" à¸«à¸£à¸·à¸­ "à¸œà¸¡à¸Šà¸·à¹ˆà¸­à¸›à¸´à¸¢à¸°"
    """
    match = re.search(r"(à¸Šà¸·à¹ˆà¸­|à¸œà¸¡à¸Šà¸·à¹ˆà¸­|à¸”à¸´à¸‰à¸±à¸™à¸Šà¸·à¹ˆà¸­|à¸‰à¸±à¸™à¸Šà¸·à¹ˆà¸­)\s*([\u0E00-\u0E7F]+)", text)
    return match.group(2) if match else "à¹„à¸¡à¹ˆà¸£à¸°à¸šà¸¸à¸Šà¸·à¹ˆà¸­"


def process_lead(user_id: str, text: str) -> dict:
    """
    à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥ lead â†’ à¹à¸¢à¸à¸Šà¸·à¹ˆà¸­ à¹€à¸šà¸­à¸£à¹Œ â†’ à¹à¸ˆà¹‰à¸‡à¹à¸­à¸”à¸¡à¸´à¸™

    Returns:
        dict: { name, phone }
    """
    name = extract_name(text)
    phone = extract_phone(text)

    # âœ… à¹à¸ˆà¹‰à¸‡à¹à¸­à¸”à¸¡à¸´à¸™à¸—à¸²à¸‡ Telegram
    notify_admin(f"[ğŸ¯ Lead à¹ƒà¸«à¸¡à¹ˆà¸ˆà¸²à¸ LINE]\nğŸ‘¤ {name}\nğŸ“± {phone}\nğŸ†” {user_id}")

    return {
        "name": name,
        "phone": phone
    }
